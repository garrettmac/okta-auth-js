{"version":3,"sources":["../../lib/TokenManager.ts"],"names":["DEFAULT_OPTIONS","autoRenew","autoRemove","storage","undefined","expireEarlySeconds","storageKey","TOKEN_STORAGE_NAME","syncStorage","_storageEventDelay","EVENT_EXPIRED","EVENT_RENEWED","EVENT_ADDED","EVENT_REMOVED","EVENT_ERROR","defaultState","expireTimeouts","renewPromise","TokenManager","constructor","sdk","options","emitter","AuthSdkError","Object","assign","storageOptions","secure","storageProvider","storageType","storageManager","getTokenStorage","clock","SdkClock","create","state","on","bind","off","start","service","stop","TokenService","getOptions","getExpireTime","token","expireTime","expiresAt","hasExpired","now","emitExpired","key","emit","emitRenewed","freshToken","oldToken","emitAdded","emitRemoved","emitError","error","emitEventsForCrossTabsStorageUpdate","newValue","oldValue","oldTokens","getTokensFromStorageValue","newTokens","keys","forEach","newToken","JSON","stringify","clearExpireEventTimeout","clearTimeout","clearExpireEventTimeoutAll","prototype","hasOwnProperty","call","setExpireEventTimeout","expireEventWait","Math","max","expireEventTimeout","setTimeout","setExpireEventTimeoutAll","tokenStorage","getStorage","resetExpireEventTimeoutAll","validateToken","add","setStorage","getSync","get","getTokensSync","tokens","accessToken","idToken","refreshToken","getTokens","getStorageKeyByType","type","filter","setTokens","accessTokenCb","idTokenCb","refreshTokenCb","handleAdded","tokenCb","handleRemoved","idTokenKey","ID_TOKEN_STORAGE_KEY","accessTokenKey","ACCESS_TOKEN_STORAGE_KEY","refreshTokenKey","REFRESH_TOKEN_STORAGE_KEY","existingTokens","remove","removedToken","renewToken","freshTokens","renewTokensWithRefresh","scopes","renew","existingPromise","e","Promise","reject","then","oldTokenStorage","catch","err","name","currentToken","tokenKey","finally","clear","clearStorage","value","parse","addWarningsForLocalhost"],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) 2015-present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n *\n */\nimport { removeNils, warn, clone } from './util';\nimport AuthSdkError from './errors/AuthSdkError';\nimport { isLocalhost, isIE11OrLess } from './features';\nimport { TOKEN_STORAGE_NAME } from './constants';\nimport SdkClock from './clock';\nimport {\n  EventEmitter,\n  Token, \n  Tokens, \n  TokenType, \n  TokenManagerOptions, \n  isIDToken, \n  isAccessToken,\n  isRefreshToken,\n  StorageOptions,\n  StorageType,\n  OktaAuth,\n  StorageProvider\n} from './types';\nimport { ID_TOKEN_STORAGE_KEY, ACCESS_TOKEN_STORAGE_KEY, REFRESH_TOKEN_STORAGE_KEY } from './constants';\nimport { TokenService } from './services/TokenService';\n\nconst DEFAULT_OPTIONS = {\n  autoRenew: true,\n  autoRemove: true,\n  storage: undefined, // will use value from storageManager config\n  expireEarlySeconds: 30,\n  storageKey: TOKEN_STORAGE_NAME,\n  syncStorage: true,\n  _storageEventDelay: 0\n};\nexport const EVENT_EXPIRED = 'expired';\nexport const EVENT_RENEWED = 'renewed';\nexport const EVENT_ADDED = 'added';\nexport const EVENT_REMOVED = 'removed';\nexport const EVENT_ERROR = 'error';\ninterface TokenError {\n  errorSummary: string;\n  errorCode: string;\n  message: string;\n  name: string;\n  tokenKey: string;\n}\ntype TokenErrorEventHandler = (error: TokenError) => void;\ntype TokenEventHandler = (key: string, token: Token, oldtoken?: Token) => void;\ninterface TokenManagerState {\n  expireTimeouts: Record<string, unknown>;\n  renewPromise: Record<string, Promise<Token>>;\n}\nfunction defaultState(): TokenManagerState {\n  return {\n    expireTimeouts: {},\n    renewPromise: {}\n  };\n}\nexport class TokenManager {\n  private sdk: OktaAuth;\n  private clock: SdkClock;\n  private emitter: EventEmitter;\n  private storage: StorageProvider;\n  private state: TokenManagerState;\n  private options: TokenManagerOptions;\n  private service: TokenService;\n\n  on: (event: string, handler: TokenErrorEventHandler | TokenEventHandler, context?: object) => void;\n  off: (event: string, handler?: TokenErrorEventHandler | TokenEventHandler) => void;\n\n  constructor(sdk: OktaAuth, options: TokenManagerOptions = {}) {\n    this.sdk = sdk;\n    this.emitter = (sdk as any).emitter;\n    if (!this.emitter) {\n      throw new AuthSdkError('Emitter should be initialized before TokenManager');\n    }\n\n    options = Object.assign({}, DEFAULT_OPTIONS, removeNils(options));\n    if (isIE11OrLess()) {\n      options._storageEventDelay = options._storageEventDelay || 1000;\n    }\n    if (!isLocalhost()) {\n      options.expireEarlySeconds = DEFAULT_OPTIONS.expireEarlySeconds;\n    }\n    this.options = options;\n\n    const storageOptions: StorageOptions = removeNils({\n      storageKey: options.storageKey,\n      secure: options.secure,\n    });\n    if (typeof options.storage === 'object') {\n      // A custom storage provider must implement getItem(key) and setItem(key, val)\n      storageOptions.storageProvider = options.storage;\n    } else if (options.storage) {\n      storageOptions.storageType = options.storage as StorageType;\n    }\n\n    this.storage = sdk.storageManager.getTokenStorage(storageOptions);\n    this.clock = SdkClock.create(/* sdk, options */);\n    this.state = defaultState();\n\n    this.on = this.emitter.on.bind(this.emitter);\n    this.off = this.emitter.off.bind(this.emitter);\n  }\n\n  start() {\n    if (this.service) {\n      this.stop();\n    }\n    this.service = new TokenService(this, this.getOptions());\n    this.service.start();\n  }\n  \n  stop() {\n    if (this.service) {\n      this.service.stop();\n      this.service = null;\n    }\n  }\n\n  getOptions(): TokenManagerOptions {\n    return clone(this.options);\n  }\n  \n  getExpireTime(token) {\n    var expireTime = token.expiresAt - this.options.expireEarlySeconds;\n    return expireTime;\n  }\n  \n  hasExpired(token) {\n    var expireTime = this.getExpireTime(token);\n    return expireTime <= this.clock.now();\n  }\n  \n  emitExpired(key, token) {\n    this.emitter.emit(EVENT_EXPIRED, key, token);\n  }\n  \n  emitRenewed(key, freshToken, oldToken) {\n    this.emitter.emit(EVENT_RENEWED, key, freshToken, oldToken);\n  }\n  \n  emitAdded(key, token) {\n    this.emitter.emit(EVENT_ADDED, key, token);\n  }\n  \n  emitRemoved(key, token?) {\n    this.emitter.emit(EVENT_REMOVED, key, token);\n  }\n  \n  emitError(error) {\n    this.emitter.emit(EVENT_ERROR, error);\n  }\n  \n  emitEventsForCrossTabsStorageUpdate(newValue, oldValue) {\n    const oldTokens = this.getTokensFromStorageValue(oldValue);\n    const newTokens = this.getTokensFromStorageValue(newValue);\n    Object.keys(newTokens).forEach(key => {\n      const oldToken = oldTokens[key];\n      const newToken = newTokens[key];\n      if (JSON.stringify(oldToken) !== JSON.stringify(newToken)) {\n        this.emitAdded(key, newToken);\n      }\n    });\n    Object.keys(oldTokens).forEach(key => {\n      const oldToken = oldTokens[key];\n      const newToken = newTokens[key];\n      if (!newToken) {\n        this.emitRemoved(key, oldToken);\n      }\n    });\n  }\n  \n  clearExpireEventTimeout(key) {\n    clearTimeout(this.state.expireTimeouts[key] as any);\n    delete this.state.expireTimeouts[key];\n  \n    // Remove the renew promise (if it exists)\n    delete this.state.renewPromise[key];\n  }\n  \n  clearExpireEventTimeoutAll() {\n    var expireTimeouts = this.state.expireTimeouts;\n    for (var key in expireTimeouts) {\n      if (!Object.prototype.hasOwnProperty.call(expireTimeouts, key)) {\n        continue;\n      }\n      this.clearExpireEventTimeout(key);\n    }\n  }\n  \n  setExpireEventTimeout(key, token) {\n    var expireTime = this.getExpireTime(token);\n    var expireEventWait = Math.max(expireTime - this.clock.now(), 0) * 1000;\n  \n    // Clear any existing timeout\n    this.clearExpireEventTimeout(key);\n  \n    var expireEventTimeout = setTimeout(() => {\n      this.emitExpired(key, token);\n    }, expireEventWait);\n  \n    // Add a new timeout\n    this.state.expireTimeouts[key] = expireEventTimeout;\n  }\n  \n  setExpireEventTimeoutAll() {\n    var tokenStorage = this.storage.getStorage();\n    for(var key in tokenStorage) {\n      if (!Object.prototype.hasOwnProperty.call(tokenStorage, key)) {\n        continue;\n      }\n      var token = tokenStorage[key];\n      this.setExpireEventTimeout(key, token);\n    }\n  }\n  \n  // reset timeouts to setup autoRenew for tokens from other document context (tabs)\n  resetExpireEventTimeoutAll() {\n    this.clearExpireEventTimeoutAll();\n    this.setExpireEventTimeoutAll();\n  }\n  \n  validateToken(token: Token) {\n    if (!isIDToken(token) && !isAccessToken(token) && !isRefreshToken(token)) {\n      throw new AuthSdkError(\n        'Token must be an Object with scopes, expiresAt, and one of: an idToken, accessToken, or refreshToken property'\n        );\n    }\n  }\n  \n  add(key, token: Token) {\n    var tokenStorage = this.storage.getStorage();\n    this.validateToken(token);\n    tokenStorage[key] = token;\n    this.storage.setStorage(tokenStorage);\n    this.emitAdded(key, token);\n    this.setExpireEventTimeout(key, token);\n  }\n  \n  getSync(key) {\n    var tokenStorage = this.storage.getStorage();\n    return tokenStorage[key];\n  }\n  \n  async get(key) {\n    return this.getSync(key);\n  }\n  \n  getTokensSync(): Tokens {\n    const tokens = {} as Tokens;\n    const tokenStorage = this.storage.getStorage();\n    Object.keys(tokenStorage).forEach(key => {\n      const token = tokenStorage[key];\n      if (isAccessToken(token)) {\n        tokens.accessToken = token;\n      } else if (isIDToken(token)) {\n        tokens.idToken = token;\n      } else if (isRefreshToken(token)) { \n        tokens.refreshToken = token;\n      }\n    });\n    return tokens;\n  }\n  \n  async getTokens(): Promise<Tokens> {\n    return this.getTokensSync();\n  }\n  \n  getStorageKeyByType(type: TokenType): string {\n    const tokenStorage = this.storage.getStorage();\n    const key = Object.keys(tokenStorage).filter(key => {\n      const token = tokenStorage[key];\n      return (isAccessToken(token) && type === 'accessToken') \n        || (isIDToken(token) && type === 'idToken')\n        || (isRefreshToken(token) && type === 'refreshToken');\n    })[0];\n    return key;\n  }\n\n  // eslint-disable-next-line complexity\n  setTokens(\n    { accessToken, idToken, refreshToken }: Tokens, \n    accessTokenCb?: Function, \n    idTokenCb?: Function,\n    refreshTokenCb?: Function\n  ): void {\n    const handleAdded = (key, token, tokenCb) => {\n      this.emitAdded(key, token);\n      this.setExpireEventTimeout(key, token);\n      if (tokenCb) {\n        tokenCb(key, token);\n      }\n    };\n    const handleRemoved = (key, token, tokenCb) => {\n      this.clearExpireEventTimeout(key);\n      this.emitRemoved(key, token);\n      if (tokenCb) {\n        tokenCb(key, token);\n      }\n    };\n  \n    if (idToken) {\n      this.validateToken(idToken);\n    }\n    if (accessToken) {\n      this.validateToken(accessToken);\n    }\n    const idTokenKey = this.getStorageKeyByType('idToken') || ID_TOKEN_STORAGE_KEY;\n    const accessTokenKey = this.getStorageKeyByType('accessToken') || ACCESS_TOKEN_STORAGE_KEY;\n    const refreshTokenKey = this.getStorageKeyByType('refreshToken') || REFRESH_TOKEN_STORAGE_KEY;\n  \n    // add token to storage\n    const tokenStorage = { \n      ...(idToken && { [idTokenKey]: idToken }),\n      ...(accessToken && { [accessTokenKey]: accessToken }),\n      ...(refreshToken && { [refreshTokenKey]: refreshToken })\n    };\n    this.storage.setStorage(tokenStorage);\n  \n    // emit event and start expiration timer\n    const existingTokens = this.getTokensSync();\n    if (idToken) {\n      handleAdded(idTokenKey, idToken, idTokenCb);\n    } else if (existingTokens.idToken) {\n      handleRemoved(idTokenKey, existingTokens.idToken, idTokenCb);\n    }\n    if (accessToken) {\n      handleAdded(accessTokenKey, accessToken, accessTokenCb);\n    } else if (existingTokens.accessToken) {\n      handleRemoved(accessTokenKey, existingTokens.accessToken, accessTokenCb);\n    }\n    if (refreshToken) {\n      handleAdded(refreshTokenKey, refreshToken, refreshTokenCb);\n    } else if (existingTokens.refreshToken) {\n      handleRemoved(refreshTokenKey, existingTokens.refreshToken, refreshTokenCb);\n    }\n  }\n  /* eslint-enable max-params */\n  \n  remove(key) {\n    // Clear any listener for this token\n    this.clearExpireEventTimeout(key);\n  \n    var tokenStorage = this.storage.getStorage();\n    var removedToken = tokenStorage[key];\n    delete tokenStorage[key];\n    this.storage.setStorage(tokenStorage);\n  \n    this.emitRemoved(key, removedToken);\n  }\n  \n  async renewToken(token) {\n    const tokens = this.getTokensSync();\n    let freshTokens;\n    if (tokens.refreshToken) {\n      freshTokens = await this.sdk.token.renewTokensWithRefresh({\n        scopes: token.scopes,\n      }, tokens.refreshToken);\n      // Multiple tokens may have come back. Return only the token which was requested.\n      return isIDToken(token) ? freshTokens.idToken : freshTokens.accessToken;\n    }\n    return this.sdk.token.renew(token);\n  }\n  \n  renew(key): Promise<Token> {\n    // Multiple callers may receive the same promise. They will all resolve or reject from the same request.\n    var existingPromise = this.state.renewPromise[key];\n    if (existingPromise) {\n      return existingPromise;\n    }\n  \n    try {\n      var token = this.getSync(key);\n      if (!token) {\n        throw new AuthSdkError('The tokenManager has no token for the key: ' + key);\n      }\n    } catch (e) {\n      return Promise.reject(e);\n    }\n  \n    // Remove existing autoRenew timeout\n    this.clearExpireEventTimeout(key);\n  \n    // A refresh token means a replace instead of renewal\n    // Store the renew promise state, to avoid renewing again\n    this.state.renewPromise[key] = this.renewToken(token)\n      .then(freshToken => {\n        // store and emit events for freshToken\n        const oldTokenStorage = this.storage.getStorage();\n        this.remove(key);\n        this.add(key, freshToken);\n        this.emitRenewed(key, freshToken, oldTokenStorage[key]);\n        return freshToken;\n      })\n      .catch(err => {\n        if (err.name === 'OAuthError' || err.name === 'AuthSdkError') {\n          // remove expired token in storage\n          const tokenStorage = this.storage.getStorage();\n          const currentToken = tokenStorage[key];\n          if (currentToken && this.hasExpired(currentToken)) {\n            delete tokenStorage[key];\n            this.clearExpireEventTimeout(key);\n            this.storage.setStorage(tokenStorage);\n            this.emitRemoved(key, currentToken);\n          } else {\n            // token have been removed from other tabs\n            // still trigger removed event for downstream listeners\n            this.emitRemoved(key);\n          }\n          \n          err.tokenKey = key;\n          this.emitError(err);\n        }\n        throw err;\n      })\n      .finally(() => {\n        // Remove existing promise key\n        delete this.state.renewPromise[key];\n      });\n  \n    return this.state.renewPromise[key];\n  }\n  \n  clear() {\n    this.clearExpireEventTimeoutAll();\n    this.storage.clearStorage();\n  }\n  \n  getTokensFromStorageValue(value) {\n    let tokens;\n    try {\n      tokens = JSON.parse(value) || {};\n    } catch (e) {\n      tokens = {};\n    }\n    return tokens;\n  }\n}\n\nif (isLocalhost()) {\n  (function addWarningsForLocalhost() {\n    const { add } = TokenManager.prototype;\n    Object.assign(TokenManager.prototype, {\n      add: function(key, token: Token) {\n        warn(\n          'Use setTokens() instead if you want to add a set of tokens at same time.\\n' + \n          'It prevents current tab from emitting unnecessary StorageEvent,\\n' + \n          'which may cause false-positive authState change cross tabs.'\n        );\n        add.call(this, key, token);\n      }\n    });\n  })();\n}\n"],"file":"TokenManager.js"}